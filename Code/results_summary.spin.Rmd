---
title: "Life and Time - PxVx - Results Summary"
output:
 pdf_document
---

```{r echo=F, warning=F, message=F}
library(MplusAutomation)
library(knitr)
library(dplyr)
library(tidyr)
library(semPlot)
library(printr)
library(stringr)
library(ggplot2)
library(broom)
library(data.table)
library(tables)
opts_chunk$set(echo=F, message=F, warning=F, dev='svg')

I2 <- function(x){
	if (length(x)==0){
		''
	} else {
		I(x)
	}
}


loadBiFN<-'../Rez/biMods.RData'
load(loadBiFN)

summaries <- biModelOut_df %>% rowwise %>%
  do({
    aSummary <- .[[1]]$summaries
    aSummaryDF <- as_data_frame(aSummary)
    aSummaryDF$numWarnings <- length(.[[1]]$warnings)
    aSummaryDF$stdErrorWarn <- any(grepl('STANDARD ERRORS COULD NOT BE COMPUTED', 
					 .[[1]]$warnings))
    aSummaryDF$numErrors <- length(.[[1]]$errors)
    aSummaryDF
  }) %>%
  extract(Title, 
          c('sample', 
	    'modelTypeP', 'pVar', 
	    'modelTypeV', 'vVar'),
          'PxVx Univariate - (\\w+) (\\w+) ([\\w_]+) with (\\w+) ([\\w_]+)') %>%
  mutate(modelNum=1:n())

convSum <- summaries %>% 
	select(sample, pVar, vVar,
	       modelTypeP, modelTypeV, numErrors, stdErrorWarn,
	       AIC, BIC) %>%
	unite(modCombo, modelTypeP, modelTypeV) %>%
	mutate(modComboText=str_replace(modCombo, 
				    '(Lin|Mean)\\w*_(Lin|Mean)\\w*',
				    'P \\1 - V \\2'),
	       modComboScore=(numErrors==0)*(1+!stdErrorWarn))
```


# What models are these results from?

## National


```{r }
modelComboSelection_l <- convSum %>% 
	group_by(sample, pVar, vVar) %>%
	do({	
		AICs <- .$AIC
		names(AICs) <- .$modCombo
		BICs <- .$BIC
		names(BICs) <- .$modCombo
		scores <- .$modComboScore
		names(scores) <- .$modCombo
		scores['Lin_Lin'] <- scores['Lin_Lin']*100
		scores[c('Lin_MeanOnly','MeanOnly_Lin')] <- scores[c('Lin_MeanOnly','MeanOnly_Lin')]*10
		maxScore <- max(scores)
		bestModelCombo <- paste(names(scores)[scores==maxScore],
					collapse=' ')
		bestModelComboAICs <- paste(AICs[scores==maxScore], collapse=' ')
		bestModelComboBICs <- paste(BICs[scores==maxScore], collapse=' ')
		data_frame(sample=.$sample[[1]],
			   pVar=.$pVar[[1]],
			   vVar=.$vVar[[1]],
			   bestCombo=bestModelCombo,
			   AIC_biv=bestModelComboAICs,
			   BIC_biv=bestModelComboBICs)
	}) 
	
modelComboSelection <- modelComboSelection_l %>%
	select(-AIC_biv, -BIC_biv) %>%
	spread(vVar, bestCombo)
```

	
All models are full linear -> linear


## College


```{r }
load('../Rez/winningUniModels.RData')

winnersByCriterion <- winnersByCriterion %>% ungroup %>%
	mutate(sample=ifelse(sample=='Inf', 'Nat', sample))

winNames <- c('AIC', 'BIC', 'LL')
names(winNames) <- paste0(winNames,'_P')
winnersByCriterionP <- winnersByCriterion %>% rename_(.dots=winNames)
names(winNames) <- paste0(winNames,'_V')
winnersByCriterionV <- winnersByCriterion %>% rename_(.dots=winNames)
```


Only the full model testing HRZ_IND with D_SCALE didn't converge. We can use
univariate fit statistics to determine that we should choose to use the model 
with restricted slope variance for HRZ_IND.


# Parameter Summaries

The tables summarize the results of the models.


```{r }
paramsummaries <- biModelOut_df %>% rowwise %>%
	do({
		if(length(.[[1]]$errors)==0){
			someParams <- .[[1]]$parameters$unstandardized
			someParams.df <- as_data_frame(someParams) %>%
				mutate(est_se=as.numeric(ifelse(est_se == '*********', NA, est_se)))
			someParams.df$Title <- as.character(.[[1]]$summaries$Title)
			someParams.df$N <- .[[1]]$summaries$Observations
			someParams.df$Estimator <- .[[1]]$summaries$Estimator
		} else {
			someParams.df <- data_frame(Title=as.character(.[[1]]$summaries$Title))
		}
		someParams.df
	}) %>%
  extract(Title, 
          c('sample', 
	    'modelTypeP', 'pVar', 
	    'modelTypeV', 'vVar'),
          'PxVx Univariate - (\\w+) (\\w+) ([\\w_]+) with (\\w+) ([\\w_]+)') %>%
mutate(paramstatement=paste(paramHeader, param, sep='.'),
       paramgroup=str_replace(paramstatement, 
			      '^([ABCDSI]|Means|Intercepts|Variances|Residual\\.Variances).*?\\.(ON|WITH)*\\.*([ABCDIS]).*',
			      '\\1 \\2 \\3'),
       withoron=str_detect(paramstatement, '\\.(WITH|ON)\\.'),
       firstVar=str_replace(paramstatement,'[ABCDIS](.*)\\.(WITH|ON)\\.[ABCDIS].*','\\1'),
       secondVar=str_replace(paramstatement,'[ABCDIS].*\\.(WITH|ON)\\.[ABCDIS](.*)','\\2'),
       bivPathType=ifelse(!is.na(firstVar) & !is.na(secondVar) & withoron,
	    		  ifelse(firstVar==secondVar,
				     'Within Var',
 				     'Across Var'),
			  'Other'),
       bivPathDir=ifelse(str_detect(paramstatement, '\\.ON\\.'),
			 ifelse(str_to_upper(firstVar)==str_to_upper(pVar),
				'Target: Pers',
				'Target: Val'),
			 NA)) %>%
	unite(modelCombo, modelTypeP, modelTypeV)

pVarInfNames <- c(I_A="BFI_A6",
		  I_C="BFI_C",
		  I_D="D_SCALE",
		  I_E="BFI_E",
		  I_N="BFI_N",
		  I_O="BFI_O",
		  I_S="S_SCALE")

pVarNames <- c(S_SCALE="Social Self-Regulation",
	       BFI_C=" Conscientiousness BFI",
	       BFA_CI="  Industriousness BFAS", 
	       BFA_CO="  Orderliness BFAS", 
	       bfi_hp8=" Honesty/Propriety BFI", 
	       BFI_A6=" Agreeableness-Six BFI", 
	       BFA_AC="  Compassion BFAS", 
	       BFA_AP="  Politeness BFAS", 
	       BFI_N=" Neuroticism BFI", 
	       BFA_NV="  Volatility BFAS", 
	       BFA_NW="  Withdrawal BFAS", 
	       D_SCALE="Dynamism", 
	       BFI_E=" Extraversion BFI", 
	       BFA_EA="  Assertiveness BFAS", 
	       BFA_EE="  Enthusiasm BFAS", 
	       BFI_O=" Openness BFI", 
	       BFA_OI="  Intellect BFAS", 
	       BFA_OO="  Openness BFAS")

XLparams_w <- paramsummaries %>% as.data.table %>% 
	filter(bivPathType=='Across Var',
	       paramgroup=='B ON A',
	       ifelse(pVar=='D_SCALE' & vVar=='HRZ_IND' & sample=='Col',
		      modelCombo=='Lin_MeanOnly',
		      modelCombo=='Lin_Lin')) %>%
	mutate(sample=ifelse(str_detect(pVar, '^I_'),
			     'Inf',
			     sample),
	       pVar=ifelse(str_detect(pVar, '^I_'),
			   pVarInfNames[pVar],
			   pVar),
	       ScaleName=factor(pVarNames[pVar], levels=pVarNames)) %>%
	select(ScaleName, vVar, sample, bivPathDir, N, est, se, pval) %>% 
	gather(parameter, value, -(ScaleName:bivPathDir)) %>%
	unite(Sample_EfDir_Param, sample, bivPathDir, parameter, sep=' ') %>%
	spread(Sample_EfDir_Param, value) %>%
	arrange(ScaleName) 


IIparams_w <- paramsummaries %>% as.data.table %>% 
	filter(bivPathType=='Across Var',
	       paramgroup=='I WITH I',
	       ifelse(pVar=='D_SCALE' & vVar=='HRZ_IND' & sample=='Col',
		      modelCombo=='Lin_MeanOnly',
		      modelCombo=='Lin_Lin')) %>%
	mutate(sample=ifelse(str_detect(pVar, '^I_'),
			     'Inf',
			     sample),
	       pVar=ifelse(str_detect(pVar, '^I_'),
			   pVarInfNames[pVar],
			   pVar),
	       ScaleName=factor(pVarNames[pVar], levels=pVarNames)) %>%
	select(ScaleName, vVar, sample, N, est, se, pval) %>% 
	gather(parameter, value, -(ScaleName:sample)) %>%
	unite(Sample_EfDir_Param, sample, parameter, sep=' ') %>%
	spread(Sample_EfDir_Param, value) %>%
	arrange(ScaleName) 

allParams_w <- paramsummaries %>% as.data.table %>% 
	filter(bivPathType=='Across Var',
	       paramgroup %in% c('B ON A','I WITH I'),
	       ifelse(pVar=='D_SCALE' & vVar=='HRZ_IND' & sample=='Col',
		      modelCombo=='Lin_MeanOnly',
		      modelCombo=='Lin_Lin')) %>%
	mutate(sample=ifelse(str_detect(pVar, '^I_'),
			     'Inf',
			     sample),
	       pVar=ifelse(str_detect(pVar, '^I_'),
			   pVarInfNames[pVar],
			   pVar),
	       ScaleName=factor(pVarNames[pVar], levels=pVarNames),
	       colName=ifelse(is.na(bivPathDir),
			      ifelse(str_detect(paramgroup, 'I WITH I'), 
				     'rPiVi', 
				     paramgroup),
			      str_replace_all(bivPathDir, 
					      c('Target: Pers'='VtoP',
						'Target: Val'='PtoV')))) %>%
	select(ScaleName, vVar, sample, colName, Estimator, N, est, se, pval) %>% 
	gather(parameter, value, -(ScaleName:colName)) %>%
	unite(Sample_EfDir_Param, sample, colName, parameter, sep=' ') %>%
	spread(Sample_EfDir_Param, value) %>%
	arrange(ScaleName) 

allParams_w_sampleLong <- paramsummaries %>% as.data.table %>% 
	filter(bivPathType=='Across Var',
	       paramgroup %in% c('B ON A','I WITH I'),
	       ifelse(pVar=='D_SCALE' & vVar=='HRZ_IND' & sample=='Col',
		      modelCombo=='Lin_MeanOnly',
		      modelCombo=='Lin_Lin')) %>%
	mutate(sample=ifelse(str_detect(pVar, '^I_'),
			     'Inf',
			     sample),
	       pVar=ifelse(str_detect(pVar, '^I_'),
			   pVarInfNames[pVar],
			   pVar),
	       ScaleName=factor(pVarNames[pVar], levels=pVarNames),
	       colName=ifelse(is.na(bivPathDir),
			      ifelse(str_detect(paramgroup, 'I WITH I'), 
				     'rPiVi', 
				     paramgroup),
			      str_replace_all(bivPathDir, 
					      c('Target: Pers'='VtoP',
						'Target: Val'='PtoV'))),
	       est.bf=ifelse(pval<.05, 
			     sprintf('\\\\textbf{%.2f}', est),
			     sprintf('%.2f', est)),
	       ci.u=est+1.96*se,
	       ci.l=est-1.96*se) %>%
	select(ScaleName, vVar, sample, colName, 
	       Estimator, N, est, est.bf, se, 
	       ci.u, ci.l, pval) %>% 
	gather(parameter, value, -(ScaleName:colName)) %>%
	unite(EfDir_Param, colName, parameter, sep=' ') %>%
	spread(EfDir_Param, value) %>%
	arrange(ScaleName) 

latexLevels <- str_replace_all(levels(allParams_w_sampleLong$ScaleName),
			   c(' (BFI|BFAS)'='\\\\textsubscript{\\1}',
			     ` `='\\\\ '))

allParams_w_sampleLongLatex <- allParams_w_sampleLong %>%
	mutate(ScaleNameLatex=factor(str_replace_all(ScaleName,
						 c(' (BFI|BFAS)'='\\\\textsubscript{\\1}',
						 ` `='\\\\ ')),
				   levels=latexLevels))

table_options(justification='r')
nada <- booktabs()
vVarNames <- c('aspfin'='Financial Aspirations',
	       'BFA_MT'='Materialism',
	       'HRZ_COL'='Horizontal Collectivism',
	       'HRZ_IND'='Horizontal Individualism',
	       'MVI_POMP'='the Mature Values Index',
	       'USI'='Unmitigated Self-Interest',
	       'VRT_COL'='Vertical Collectivism',
	       'VRT_IND'='Vertical Individualism')

```{r 'thing4', results='asis'}
nada <- allParams_w_sampleLongLatex %>% 
	group_by(vVar) %>%
	do({
		atable <- tabular(Heading()*(scale=Factor(ScaleNameLatex, texify=F))~
				  Heading()*I2*
				  Heading()*(sample=factor(sample, 
							   levels=c('Nat', 'Col', 'Inf'),
							   labels=c('National Sample',
								    'Student Sample',
								    'Informant Sample')))*
				     Justify(r)*
				     ((N=`PtoV N`)+
				      (`$P\\rightarrow V$`=`PtoV est.bf`)+
				      (`$V\\rightarrow P$`=`VtoP est.bf`)+
				      (`$r_{P_{i}V_{i}}$`=`rPiVi est.bf`)), 
				     data=.) # %>% cat #%>% latex()
		cat('\n\\begin{table}')
		cat(paste0('\n\\caption{Auto-Regressive Associations Between \\textbf{',
			  vVarNames[unique(.$vVar)],
			  '} and Personality Scales, Accounting for Age}\n'))
		cat('\\begin{adjustbox}{max width=\\columnwidth, min width=\\columnwidth}\n')
		latex(atable)
		cat('\\end{adjustbox}\n')
		cat('\\end{table}\n')
		data_frame(aHTMLTable=list(atable))
	})
```


---
title: "results_summary.r"
author: "jflournoy"
date: "Wed Mar 23 16:17:59 2016"
---
